"use strict";(()=>{var e={};e.id=7146,e.ids=[7146],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},84770:e=>{e.exports=require("crypto")},79242:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>f,patchFetch:()=>v,requestAsyncStorage:()=>y,routeModule:()=>m,serverHooks:()=>D,staticGenerationAsyncStorage:()=>h});var a={};r.r(a),r.d(a,{GET:()=>p,POST:()=>w,dynamic:()=>d});var i=r(49303),n=r(88716),o=r(60670),s=r(87070),c=r(2310),l=r(57044);let d="force-dynamic",u=[{id:"eco-warrior",name:"\uD83C\uDF31 Eco Warrior Badge",description:"Achieve your first milestone as an environmental champion",points_required:50,level_required:1,category:"achievement",icon:"\uD83C\uDF31"},{id:"recycling-master",name:"â™»ï¸ Recycling Master",description:"Prove your expertise in waste classification and collection",points_required:100,level_required:2,category:"expertise",icon:"â™»ï¸"},{id:"community-hero",name:"\uD83C\uDFC6 Community Hero",description:"Lead by example and inspire others to join the movement",points_required:200,level_required:3,category:"leadership",icon:"\uD83C\uDFC6"},{id:"planet-protector",name:"\uD83C\uDF0D Planet Protector",description:"Reach the highest level of environmental stewardship",points_required:500,level_required:5,category:"mastery",icon:"\uD83C\uDF0D"},{id:"waste-spotter",name:"\uD83C\uDFAF Waste Spotter",description:"Develop keen eyes for identifying different types of waste",points_required:75,level_required:1,category:"skill",icon:"\uD83C\uDFAF"},{id:"quick-collector",name:"\uD83D\uDE80 Quick Collector",description:"Master the art of efficient waste collection",points_required:150,level_required:2,category:"efficiency",icon:"\uD83D\uDE80"},{id:"innovation-leader",name:"\uD83D\uDCA1 Innovation Leader",description:"Contribute to improving waste management processes",points_required:300,level_required:4,category:"innovation",icon:"\uD83D\uDCA1"},{id:"sustainability-champion",name:"\uD83C\uDF1F Sustainability Champion",description:"The ultimate recognition for environmental dedication",points_required:1e3,level_required:10,category:"legendary",icon:"\uD83C\uDF1F"},{id:"waste-detective",name:"\uD83D\uDD0D Waste Detective",description:"Specialize in identifying and reporting complex waste situations",points_required:125,level_required:2,category:"specialization",icon:"\uD83D\uDD0D"},{id:"speed-demon",name:"âš¡ Speed Demon",description:"Complete waste collection tasks with exceptional efficiency",points_required:175,level_required:3,category:"efficiency",icon:"âš¡"},{id:"creative-recycler",name:"\uD83C\uDFA8 Creative Recycler",description:"Find innovative ways to handle and report waste",points_required:250,level_required:3,category:"creativity",icon:"\uD83C\uDFA8"},{id:"team-player",name:"\uD83E\uDD1D Team Player",description:"Collaborate effectively with other waste collectors",points_required:400,level_required:4,category:"collaboration",icon:"\uD83E\uDD1D"},{id:"knowledge-seeker",name:"\uD83D\uDCDA Knowledge Seeker",description:"Continuously learn about waste management best practices",points_required:80,level_required:1,category:"learning",icon:"\uD83D\uDCDA"},{id:"consistency-king",name:"\uD83D\uDD04 Consistency King",description:"Maintain regular participation in waste collection activities",points_required:600,level_required:6,category:"dedication",icon:"\uD83D\uDD04"},{id:"veteran-collector",name:"\uD83C\uDF96ï¸ Veteran Collector",description:"Long-term commitment to environmental protection",points_required:800,level_required:8,category:"veteran",icon:"\uD83C\uDF96ï¸"}];async function p(e){try{let t;let{searchParams:r}=new URL(e.url),a=r.get("type");if("transactions"===a){let r=await (0,c.nX)(e);if(!r)return s.NextResponse.json({error:"Unauthorized"},{status:401});t=await (0,l.VC)(r.id)}else if("available"===a)try{let r=await (0,c.nX)(e);if(r){let e=await (0,l._y)(r.id),a=e.find(e=>0===e.id)?.cost||0;t=u.map(e=>({...e,cost:e.points_required,isUnlocked:a>=e.points_required,progress:Math.min(a/e.points_required*100,100),collectionInfo:`Unlock this badge by earning ${e.points_required} points and reaching level ${e.level_required}`}))}else t=u.map(e=>({...e,cost:e.points_required,isUnlocked:!1,progress:0,collectionInfo:`Unlock this badge by earning ${e.points_required} points and reaching level ${e.level_required}`}))}catch(e){t=u.map(e=>({...e,cost:e.points_required,isUnlocked:!1,progress:0,collectionInfo:`Unlock this badge by earning ${e.points_required} points and reaching level ${e.level_required}`}))}else{if(!await (0,c.nX)(e))return s.NextResponse.json({error:"Unauthorized"},{status:401});t=await (0,l.IQ)()}return s.NextResponse.json(t)}catch(e){return s.NextResponse.json({error:"Internal server error"},{status:500})}}async function w(e){try{let{userId:t,amount:r}=await e.json(),a=await (0,l.rF)(t,r);if(!a)return s.NextResponse.json({error:"Failed to save reward"},{status:400});return s.NextResponse.json(a)}catch(e){return s.NextResponse.json({error:"Internal server error"},{status:500})}}let m=new i.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/rewards/route",pathname:"/api/rewards",filename:"route",bundlePath:"app/api/rewards/route"},resolvedPagePath:"C:\\Users\\devan\\Downloads\\zero2hero-Waste-Management-System-master\\src\\app\\api\\rewards\\route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:y,staticGenerationAsyncStorage:h,serverHooks:D}=m,f="/api/rewards/route";function v(){return(0,o.patchFetch)({serverHooks:D,staticGenerationAsyncStorage:h})}},57044:(e,t,r)=>{r.d(t,{$4:()=>x,CX:()=>l,Go:()=>y,IQ:()=>R,QW:()=>v,VC:()=>q,_Y:()=>g,_y:()=>_,fJ:()=>D,gG:()=>m,n3:()=>C,rF:()=>f,zA:()=>c,zH:()=>h});var a=r(42633),i=r(48645),n=r(57745),o=r(62315),s=r(81445);let c=async()=>{if(!a.db)throw Error("Database not initialized");try{await a.db.select().from(i.Users).limit(1)}catch(e){throw Error("Database connection failed")}return a.db},l=async e=>{if(!e)return null;try{let t=await c();return(await t.select({id:i.Users.id,email:i.Users.email,name:i.Users.name,createdAt:i.Users.createdAt,image:i.Users.image,updatedAt:i.Users.updatedAt}).from(i.Users).where((0,n.eq)(i.Users.email,e)).execute())[0]||null}catch(e){return null}},d=async e=>{try{let t=await c(),[r]=await t.select().from(i.Rewards).where((0,n.eq)(i.Rewards.userId,e));return r||([r]=await t.insert(i.Rewards).values({userId:e,name:"Default Reward",collectionInfo:"Default Collection Info",points:0,level:1,isAvailable:!0}).returning()),r}catch(e){return null}},u=async(e,t)=>{try{let r=await c(),[a]=await r.update(i.Rewards).set({points:(0,o.i6)`${i.Rewards.points} + ${t}`,updatedAt:new Date}).where((0,n.eq)(i.Rewards.userId,e)).returning();return a}catch(e){return null}},p=async(e,t,r,a)=>{try{let n=await c(),[o]=await n.insert(i.Transactions).values({userId:e,type:t,amount:r,description:a,date:new Date}).returning();return o}catch(e){return null}},w=async(e,t,r,a,n)=>{try{let o=await c(),[s]=await o.insert(i.Notifications).values({userId:e,message:t,type:r,imageUrl:a,metadata:n}).returning();return s}catch(e){throw e}},m=async e=>{try{let t=await c();return await t.select().from(i.Notifications).where((0,n.xD)((0,n.eq)(i.Notifications.userId,e),(0,n.eq)(i.Notifications.isRead,!1)))}catch(e){return[]}},y=async e=>{try{let t=await c();return await t.update(i.Notifications).set({isRead:!0}).where((0,n.eq)(i.Notifications.id,e)),!0}catch(e){throw e}},h=async(e=20)=>{try{let t=await c();return await t.select({id:i.Reports.id,userId:i.Reports.userId,location:i.Reports.location,wasteType:i.Reports.wasteType,amount:i.Reports.amount,imageUrl:i.Reports.imageUrl,verificationResult:i.Reports.verificationResult,status:i.Reports.status,createdAt:i.Reports.createdAt,collectorId:i.Reports.collectorId,userName:i.Users.name,userEmail:i.Users.email}).from(i.Reports).leftJoin(i.Users,(0,n.eq)(i.Reports.userId,i.Users.id)).orderBy((0,s.C)(i.Reports.createdAt)).limit(e)}catch(e){return[]}},D=async(e=10)=>{try{let t=await c();return await t.select().from(i.Reports).orderBy((0,s.C)(i.Reports.createdAt)).limit(e)}catch(e){return[]}},f=async(e,t)=>{try{let r=await c(),[a]=await r.insert(i.Rewards).values({userId:e,name:"Waste Collection Reward",collectionInfo:"Points earned from waste collection",points:t,level:1,isAvailable:!0}).returning();return await I(e,"earned_collect",t,"Points earned for collecting waste"),a}catch(e){throw e}},v=async(e,t,r)=>{try{let a=await c();if(void 0!==r){let[e]=await a.select().from(i.Users).where((0,n.eq)(i.Users.id,r)).limit(1);if(!e)throw Error(`Invalid collector ID: ${r}. User does not exist.`)}let o={status:t};void 0!==r&&(o.collectorId=r);let[s]=await a.update(i.Reports).set(o).where((0,n.eq)(i.Reports.id,e)).returning();if(!s)throw Error(`No report found with ID ${e}`);return s}catch(e){throw e}},g=async(e,t,r,a)=>{try{let o=await c(),[s]=await o.select().from(i.Reports).where((0,n.eq)(i.Reports.id,e)).limit(1);if(!s||!s.userId)throw Error("Report not found or missing user ID");let[l]=await o.update(i.Reports).set({status:"completed",collectorId:t,verificationResult:r,imageUrl:a}).where((0,n.eq)(i.Reports.id,e)).returning(),m=(s.wasteType,s.amount,75);await p(s.userId,"earned_collection",m,`Waste collection completed (75 tokens for task completion): ${s.wasteType} at ${s.location}`),await d(s.userId),await u(s.userId,m);let y=`ðŸŽ‰ Your waste report has been collected! You earned ${m} tokens (75 tokens for task completion). ${a?"Check out the completion photo below!":""}`,h={reportId:e,rewardAmount:m,wasteType:s.wasteType,location:s.location,collectionDate:new Date().toISOString()};await w(s.userId,y,"completion_with_photo",a,h);let[D]=await o.insert(i.CollectedWastes).values({reportId:e,collectorId:t,collectionDate:new Date,verificationResult:r}).returning();return{updatedReport:l,collectedWaste:D,rewardAmount:m,userId:s.userId}}catch(e){throw e}},R=async()=>{try{let e=await c();return await e.select({id:i.Rewards.id,userId:i.Rewards.userId,points:i.Rewards.points,level:i.Rewards.level,createdAt:i.Rewards.createdAt,userName:i.Users.name}).from(i.Rewards).leftJoin(i.Users,(0,n.eq)(i.Rewards.userId,i.Users.id)).orderBy((0,s.C)(i.Rewards.points))}catch(e){return[]}},q=async e=>{try{let t=await c();return(await t.select({id:i.Transactions.id,type:i.Transactions.type,amount:i.Transactions.amount,description:i.Transactions.description,date:i.Transactions.date}).from(i.Transactions).where((0,n.eq)(i.Transactions.userId,e)).orderBy((0,s.C)(i.Transactions.date)).limit(10)).map(e=>({...e,date:e.date.toISOString().split("T")[0]}))}catch(e){return[]}},_=async e=>{try{let t=await c(),r=(await q(e)).reduce((e,t)=>t.type.startsWith("earned")?e+t.amount:e-t.amount,0),a=await t.select({id:i.Rewards.id,name:i.Rewards.name,cost:i.Rewards.points,description:i.Rewards.description,collectionInfo:i.Rewards.collectionInfo}).from(i.Rewards).where((0,n.eq)(i.Rewards.isAvailable,!0));return[{id:0,name:"Your Points",cost:r,description:"Redeem your earned points",collectionInfo:"Points earned from reporting and collecting waste"},...a]}catch(e){return[]}},I=async(e,t,r,a)=>{try{let n=await c(),[o]=await n.insert(i.Transactions).values({userId:e,type:t,amount:r,description:a}).returning();return o}catch(e){throw e}},C=async e=>{try{let t=(await a.db.select({type:i.Transactions.type,amount:i.Transactions.amount}).from(i.Transactions).where((0,n.eq)(i.Transactions.userId,e))).reduce((e,t)=>{let r=e;return["earned_report","earned_collection","earned_collect","reward"].includes(t.type)?r=e+t.amount:["redeemed","spent"].includes(t.type)&&(r=e-t.amount),r},0);return Math.max(t,0)}catch(e){return 0}},x=async(e,t,r)=>{try{let a=await c(),[o]=await a.insert(i.CollectedWastes).values({reportId:e,collectorId:t,collectionDate:new Date,status:"collected",verificationResult:r?JSON.stringify(r):null}).returning();if(!o)throw Error("Failed to create collected waste record");await a.update(i.Reports).set({status:"collected",collectorId:t}).where((0,n.eq)(i.Reports.id,e));let[s]=await a.select({userId:i.Reports.userId,location:i.Reports.location}).from(i.Reports).where((0,n.eq)(i.Reports.id,e));return s&&s.userId&&(await a.insert(i.Notifications).values({userId:s.userId,message:`Your reported waste at ${s.location} has been collected and verified!`,type:"collection_complete",isRead:!1}),await u(t,20),await I(t,"earned_collect",20,"Points earned for collecting waste"),await w(t,"You've earned 20 points for collecting waste!","reward")),o}catch(e){throw e}}}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[8948,5972,7917,2310],()=>r(79242));module.exports=a})();