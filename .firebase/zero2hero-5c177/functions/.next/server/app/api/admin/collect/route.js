"use strict";(()=>{var e={};e.id=1302,e.ids=[1302],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},98416:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>R,patchFetch:()=>N,requestAsyncStorage:()=>f,routeModule:()=>m,serverHooks:()=>y,staticGenerationAsyncStorage:()=>h});var r={};a.r(r),a.d(r,{PATCH:()=>p,POST:()=>w,dynamic:()=>u});var s=a(49303),o=a(88716),n=a(60670),i=a(87070),l=a(57044),d=a(48645),c=a(57745);let u="force-dynamic";async function p(e){try{let t,a;let r=e.cookies.get("admin_session")?.value;if(!r)return i.NextResponse.json({error:"Admin authentication required"},{status:401});try{t=JSON.parse(r)}catch(e){return i.NextResponse.json({error:"Invalid admin session"},{status:401})}let{taskId:s,newStatus:o}=await e.json();if(!s||!o)return i.NextResponse.json({error:"taskId and newStatus are required"},{status:400});let n=await (0,l.zA)();try{let e=t.email||"admin@wastecollection.com",[r]=await n.select().from(d.Users).where((0,c.eq)(d.Users.email,e)).limit(1);if(r)a=r.id;else try{let[r]=await n.insert(d.Users).values({email:e,name:t.name||"System Admin",password:"temp-admin-password",balance:0}).returning();a=r.id}catch(r){let[t]=await n.select().from(d.Users).where((0,c.eq)(d.Users.email,e)).limit(1);a=t?t.id:void 0}}catch(e){a=void 0}let u=await (0,l.QW)(s,o,a);if(!u)return i.NextResponse.json({error:"Task not found or update failed"},{status:404});let p={...u,createdAt:u.createdAt?.toISOString()};return i.NextResponse.json(p)}catch(t){let e=t instanceof Error?t.message:"Unknown error";return i.NextResponse.json({error:"Internal server error",details:e},{status:500})}}async function w(e){try{let t,a;let r=e.cookies.get("admin_session")?.value;if(!r)return i.NextResponse.json({error:"Admin authentication required"},{status:401});try{t=JSON.parse(r)}catch(e){return i.NextResponse.json({error:"Invalid admin session"},{status:401})}let{taskId:s,reportId:o,verificationResult:n,imageUrl:u}=await e.json(),p=await (0,l.zA)();try{let e=t.email||"admin@wastecollection.com",[r]=await p.select().from(d.Users).where((0,c.eq)(d.Users.email,e)).limit(1);if(r)a=r.id;else try{let[r]=await p.insert(d.Users).values({email:e,name:t.name||"System Admin",password:"temp-admin-password",balance:0}).returning();a=r.id}catch(r){let[t]=await p.select().from(d.Users).where((0,c.eq)(d.Users.email,e)).limit(1);if(!t)return i.NextResponse.json({error:"Failed to create or find admin user"},{status:500});a=t.id}}catch(e){return i.NextResponse.json({error:"Failed to handle admin user authentication"},{status:500})}let w=await (0,l._Y)(s||o,a,n,u),m={...w,updatedReport:{...w.updatedReport,createdAt:w.updatedReport.createdAt?.toISOString()},collectedWaste:{...w.collectedWaste,collectionDate:w.collectedWaste.collectionDate?.toISOString()}};return i.NextResponse.json({success:!0,message:`Task completed successfully! User earned ${w.rewardAmount} tokens.`,data:m})}catch(e){return i.NextResponse.json({error:"Failed to complete task",details:e instanceof Error?e.message:"Unknown error"},{status:500})}}let m=new s.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/admin/collect/route",pathname:"/api/admin/collect",filename:"route",bundlePath:"app/api/admin/collect/route"},resolvedPagePath:"C:\\Users\\devan\\Downloads\\zero2hero-Waste-Management-System-master\\src\\app\\api\\admin\\collect\\route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:f,staticGenerationAsyncStorage:h,serverHooks:y}=m,R="/api/admin/collect/route";function N(){return(0,n.patchFetch)({serverHooks:y,staticGenerationAsyncStorage:h})}},57044:(e,t,a)=>{a.d(t,{$4:()=>U,CX:()=>d,Go:()=>f,IQ:()=>g,QW:()=>N,VC:()=>v,_Y:()=>_,_y:()=>I,fJ:()=>y,gG:()=>m,n3:()=>L,rF:()=>R,zA:()=>l,zH:()=>h});var r=a(42633),s=a(48645),o=a(57745),n=a(62315),i=a(81445);let l=async()=>{if(!r.db)throw Error("Database not initialized");try{await r.db.select().from(s.Users).limit(1)}catch(e){throw Error("Database connection failed")}return r.db},d=async e=>{if(!e)return null;try{let t=await l();return(await t.select({id:s.Users.id,email:s.Users.email,name:s.Users.name,createdAt:s.Users.createdAt,image:s.Users.image,updatedAt:s.Users.updatedAt}).from(s.Users).where((0,o.eq)(s.Users.email,e)).execute())[0]||null}catch(e){return null}},c=async e=>{try{let t=await l(),[a]=await t.select().from(s.Rewards).where((0,o.eq)(s.Rewards.userId,e));return a||([a]=await t.insert(s.Rewards).values({userId:e,name:"Default Reward",collectionInfo:"Default Collection Info",points:0,level:1,isAvailable:!0}).returning()),a}catch(e){return null}},u=async(e,t)=>{try{let a=await l(),[r]=await a.update(s.Rewards).set({points:(0,n.i6)`${s.Rewards.points} + ${t}`,updatedAt:new Date}).where((0,o.eq)(s.Rewards.userId,e)).returning();return r}catch(e){return null}},p=async(e,t,a,r)=>{try{let o=await l(),[n]=await o.insert(s.Transactions).values({userId:e,type:t,amount:a,description:r,date:new Date}).returning();return n}catch(e){return null}},w=async(e,t,a,r,o)=>{try{let n=await l(),[i]=await n.insert(s.Notifications).values({userId:e,message:t,type:a,imageUrl:r,metadata:o}).returning();return i}catch(e){throw e}},m=async e=>{try{let t=await l();return await t.select().from(s.Notifications).where((0,o.xD)((0,o.eq)(s.Notifications.userId,e),(0,o.eq)(s.Notifications.isRead,!1)))}catch(e){return[]}},f=async e=>{try{let t=await l();return await t.update(s.Notifications).set({isRead:!0}).where((0,o.eq)(s.Notifications.id,e)),!0}catch(e){throw e}},h=async(e=20)=>{try{let t=await l();return await t.select({id:s.Reports.id,userId:s.Reports.userId,location:s.Reports.location,wasteType:s.Reports.wasteType,amount:s.Reports.amount,imageUrl:s.Reports.imageUrl,verificationResult:s.Reports.verificationResult,status:s.Reports.status,createdAt:s.Reports.createdAt,collectorId:s.Reports.collectorId,userName:s.Users.name,userEmail:s.Users.email}).from(s.Reports).leftJoin(s.Users,(0,o.eq)(s.Reports.userId,s.Users.id)).orderBy((0,i.C)(s.Reports.createdAt)).limit(e)}catch(e){return[]}},y=async(e=10)=>{try{let t=await l();return await t.select().from(s.Reports).orderBy((0,i.C)(s.Reports.createdAt)).limit(e)}catch(e){return[]}},R=async(e,t)=>{try{let a=await l(),[r]=await a.insert(s.Rewards).values({userId:e,name:"Waste Collection Reward",collectionInfo:"Points earned from waste collection",points:t,level:1,isAvailable:!0}).returning();return await A(e,"earned_collect",t,"Points earned for collecting waste"),r}catch(e){throw e}},N=async(e,t,a)=>{try{let r=await l();if(void 0!==a){let[e]=await r.select().from(s.Users).where((0,o.eq)(s.Users.id,a)).limit(1);if(!e)throw Error(`Invalid collector ID: ${a}. User does not exist.`)}let n={status:t};void 0!==a&&(n.collectorId=a);let[i]=await r.update(s.Reports).set(n).where((0,o.eq)(s.Reports.id,e)).returning();if(!i)throw Error(`No report found with ID ${e}`);return i}catch(e){throw e}},_=async(e,t,a,r)=>{try{let n=await l(),[i]=await n.select().from(s.Reports).where((0,o.eq)(s.Reports.id,e)).limit(1);if(!i||!i.userId)throw Error("Report not found or missing user ID");let[d]=await n.update(s.Reports).set({status:"completed",collectorId:t,verificationResult:a,imageUrl:r}).where((0,o.eq)(s.Reports.id,e)).returning(),m=(i.wasteType,i.amount,75);await p(i.userId,"earned_collection",m,`Waste collection completed (75 tokens for task completion): ${i.wasteType} at ${i.location}`),await c(i.userId),await u(i.userId,m);let f=`ðŸŽ‰ Your waste report has been collected! You earned ${m} tokens (75 tokens for task completion). ${r?"Check out the completion photo below!":""}`,h={reportId:e,rewardAmount:m,wasteType:i.wasteType,location:i.location,collectionDate:new Date().toISOString()};await w(i.userId,f,"completion_with_photo",r,h);let[y]=await n.insert(s.CollectedWastes).values({reportId:e,collectorId:t,collectionDate:new Date,verificationResult:a}).returning();return{updatedReport:d,collectedWaste:y,rewardAmount:m,userId:i.userId}}catch(e){throw e}},g=async()=>{try{let e=await l();return await e.select({id:s.Rewards.id,userId:s.Rewards.userId,points:s.Rewards.points,level:s.Rewards.level,createdAt:s.Rewards.createdAt,userName:s.Users.name}).from(s.Rewards).leftJoin(s.Users,(0,o.eq)(s.Rewards.userId,s.Users.id)).orderBy((0,i.C)(s.Rewards.points))}catch(e){return[]}},v=async e=>{try{let t=await l();return(await t.select({id:s.Transactions.id,type:s.Transactions.type,amount:s.Transactions.amount,description:s.Transactions.description,date:s.Transactions.date}).from(s.Transactions).where((0,o.eq)(s.Transactions.userId,e)).orderBy((0,i.C)(s.Transactions.date)).limit(10)).map(e=>({...e,date:e.date.toISOString().split("T")[0]}))}catch(e){return[]}},I=async e=>{try{let t=await l(),a=(await v(e)).reduce((e,t)=>t.type.startsWith("earned")?e+t.amount:e-t.amount,0),r=await t.select({id:s.Rewards.id,name:s.Rewards.name,cost:s.Rewards.points,description:s.Rewards.description,collectionInfo:s.Rewards.collectionInfo}).from(s.Rewards).where((0,o.eq)(s.Rewards.isAvailable,!0));return[{id:0,name:"Your Points",cost:a,description:"Redeem your earned points",collectionInfo:"Points earned from reporting and collecting waste"},...r]}catch(e){return[]}},A=async(e,t,a,r)=>{try{let o=await l(),[n]=await o.insert(s.Transactions).values({userId:e,type:t,amount:a,description:r}).returning();return n}catch(e){throw e}},L=async e=>{try{let t=(await r.db.select({type:s.Transactions.type,amount:s.Transactions.amount}).from(s.Transactions).where((0,o.eq)(s.Transactions.userId,e))).reduce((e,t)=>{let a=e;return["earned_report","earned_collection","earned_collect","reward"].includes(t.type)?a=e+t.amount:["redeemed","spent"].includes(t.type)&&(a=e-t.amount),a},0);return Math.max(t,0)}catch(e){return 0}},U=async(e,t,a)=>{try{let r=await l(),[n]=await r.insert(s.CollectedWastes).values({reportId:e,collectorId:t,collectionDate:new Date,status:"collected",verificationResult:a?JSON.stringify(a):null}).returning();if(!n)throw Error("Failed to create collected waste record");await r.update(s.Reports).set({status:"collected",collectorId:t}).where((0,o.eq)(s.Reports.id,e));let[i]=await r.select({userId:s.Reports.userId,location:s.Reports.location}).from(s.Reports).where((0,o.eq)(s.Reports.id,e));return i&&i.userId&&(await r.insert(s.Notifications).values({userId:i.userId,message:`Your reported waste at ${i.location} has been collected and verified!`,type:"collection_complete",isRead:!1}),await u(t,20),await A(t,"earned_collect",20,"Points earned for collecting waste"),await w(t,"You've earned 20 points for collecting waste!","reward")),n}catch(e){throw e}}},42633:(e,t,a)=>{a.d(t,{db:()=>i});var r=a(17917),s=a(62237),o=a(48645);let n=(0,s.qn)("postgresql://neondb_owner:Devansh%4077@ep-weathered-waterfall-a16ci7i1-pooler.ap-southeast-1.aws.neon.tech/neondb?sslmode=require"),i=(0,r.tS)(n,{schema:o})},48645:(e,t,a)=>{a.r(t),a.d(t,{CollectedWastes:()=>m,Notifications:()=>f,Reports:()=>p,Rewards:()=>w,Transactions:()=>h,Users:()=>u,WasteCollectionTasks:()=>R,available_rewards:()=>y,collectedWaste:()=>v,notifications:()=>I,reports:()=>_,rewards:()=>g,transactions:()=>A,users:()=>N,wasteCollectionTasks:()=>L});var r=a(23733),s=a(95961),o=a(41401),n=a(12941),i=a(1575),l=a(72140),d=a(98748),c=a(28680);let u=(0,r.af)("users",{id:(0,s.eP)("id").primaryKey(),name:(0,o.L7)("name",{length:255}).notNull(),email:(0,o.L7)("email",{length:255}).notNull().unique(),password:(0,o.L7)("password",{length:255}),firebaseUid:(0,o.L7)("firebase_uid",{length:255}).unique(),authProvider:(0,o.L7)("auth_provider",{length:20}).default("email").notNull(),balance:(0,n._L)("balance").default(0).notNull(),createdAt:(0,i.AB)("created_at").defaultNow().notNull(),updatedAt:(0,i.AB)("updated_at").defaultNow(),image:(0,l.fL)("image"),publicProfileVisible:(0,d.O7)("public_profile_visible").default(!0).notNull(),profileSearchable:(0,d.O7)("profile_searchable").default(!0).notNull(),showRealName:(0,d.O7)("show_real_name").default(!1).notNull(),personalStatsVisible:(0,d.O7)("personal_stats_visible").default(!0).notNull(),dataSharing:(0,o.L7)("data_sharing",{length:20}).default("anonymous").notNull(),environmentalTracking:(0,d.O7)("environmental_tracking").default(!0).notNull(),collectionHistoryRetention:(0,o.L7)("collection_history_retention",{length:20}).default("1year").notNull()}),p=(0,r.af)("reports",{id:(0,s.eP)("id").primaryKey(),userId:(0,n._L)("user_id").references(()=>u.id),location:(0,l.fL)("location").notNull(),wasteType:(0,o.L7)("waste_type",{length:255}).notNull(),amount:(0,o.L7)("amount",{length:255}).notNull(),imageUrl:(0,l.fL)("image_url"),verificationResult:(0,c.JB)("verification_result"),status:(0,o.L7)("status",{length:255}).notNull().default("pending"),createdAt:(0,i.AB)("created_at").defaultNow().notNull(),collectorId:(0,n._L)("collector_id").references(()=>u.id)}),w=(0,r.af)("rewards",{id:(0,s.eP)("id").primaryKey(),userId:(0,n._L)("user_id").references(()=>u.id).notNull(),points:(0,n._L)("points").notNull().default(0),level:(0,n._L)("level").notNull().default(1),createdAt:(0,i.AB)("created_at").defaultNow().notNull(),updatedAt:(0,i.AB)("updated_at").defaultNow().notNull(),isAvailable:(0,d.O7)("is_available").notNull().default(!0),description:(0,l.fL)("description"),name:(0,o.L7)("name",{length:255}).notNull(),collectionInfo:(0,l.fL)("collection_info").notNull()}),m=(0,r.af)("collected_wastes",{id:(0,s.eP)("id").primaryKey(),reportId:(0,n._L)("report_id").references(()=>p.id).notNull(),collectorId:(0,n._L)("collector_id").references(()=>u.id).notNull(),collectionDate:(0,i.AB)("collection_date").notNull(),status:(0,o.L7)("status",{length:20}).notNull().default("collected"),amount:(0,o.L7)("amount",{length:255}),verificationResult:(0,c.JB)("verification_result")}),f=(0,r.af)("notifications",{id:(0,s.eP)("id").primaryKey(),userId:(0,n._L)("user_id").references(()=>u.id).notNull(),message:(0,l.fL)("message").notNull(),type:(0,o.L7)("type",{length:50}).notNull(),isRead:(0,d.O7)("is_read").notNull().default(!1),imageUrl:(0,l.fL)("image_url"),metadata:(0,c.JB)("metadata"),createdAt:(0,i.AB)("created_at").defaultNow().notNull()}),h=(0,r.af)("transactions",{id:(0,s.eP)("id").primaryKey(),userId:(0,n._L)("user_id").references(()=>u.id).notNull(),type:(0,o.L7)("type",{length:20}).notNull(),amount:(0,n._L)("amount").notNull(),description:(0,l.fL)("description").notNull(),date:(0,i.AB)("date").defaultNow().notNull()}),y=(0,r.af)("available_rewards",{id:(0,s.eP)("id").primaryKey(),name:(0,o.L7)("name",{length:255}).notNull(),description:(0,l.fL)("description"),points_required:(0,n._L)("points_required").notNull(),level_required:(0,n._L)("level_required").notNull(),created_at:(0,i.AB)("created_at").defaultNow().notNull(),updated_at:(0,i.AB)("updated_at").defaultNow().notNull()}),R=(0,r.af)("waste_collection_tasks",{id:(0,s.eP)("id").primaryKey(),createdBy:(0,n._L)("created_by").references(()=>u.id).notNull(),location:(0,l.fL)("location").notNull(),description:(0,l.fL)("description"),status:(0,o.L7)("status",{length:20}).default("active").notNull(),createdAt:(0,i.AB)("created_at").defaultNow().notNull(),completedAt:(0,i.AB)("completed_at")}),N=u,_=p,g=w,v=m,I=f,A=h,L=R}};var t=require("../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),r=t.X(0,[8948,5972,7917],()=>a(98416));module.exports=r})();