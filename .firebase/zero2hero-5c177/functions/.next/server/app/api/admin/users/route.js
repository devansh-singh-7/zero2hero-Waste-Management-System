"use strict";(()=>{var e={};e.id=2628,e.ids=[2628],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},84770:e=>{e.exports=require("crypto")},97457:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>y,patchFetch:()=>L,requestAsyncStorage:()=>_,routeModule:()=>h,serverHooks:()=>A,staticGenerationAsyncStorage:()=>g});var a={};r.r(a),r.d(a,{DELETE:()=>m,GET:()=>f,PATCH:()=>N,POST:()=>w,dynamic:()=>p});var s=r(49303),n=r(88716),o=r(60670),l=r(87070),i=r(42633),d=r(48645),u=r(57745),c=r(98691);let p="force-dynamic";async function f(e){try{if(!e.cookies.get("admin_session")?.value)return l.NextResponse.json({error:"Admin authentication required"},{status:401});let t=(await i.db.select({id:d.Users.id,name:d.Users.name,email:d.Users.email,balance:d.Users.balance,createdAt:d.Users.createdAt,updatedAt:d.Users.updatedAt}).from(d.Users).orderBy(d.Users.createdAt)).map(e=>({...e,createdAt:e.createdAt?.toISOString(),updatedAt:e.updatedAt?.toISOString()}));return l.NextResponse.json(t)}catch(e){return l.NextResponse.json({error:"Failed to fetch users"},{status:500})}}async function m(e){try{if(!e.cookies.get("admin_session")?.value)return l.NextResponse.json({error:"Admin authentication required"},{status:401});let{searchParams:t}=new URL(e.url),r=t.get("id");if(!r)return l.NextResponse.json({error:"User ID is required"},{status:400});let a=parseInt(r),s=await i.db.select().from(d.Users).where((0,u.eq)(d.Users.id,a)).limit(1);if(0===s.length)return l.NextResponse.json({error:"User not found"},{status:404});try{await i.db.delete(d.Notifications).where((0,u.eq)(d.Notifications.userId,a)),await i.db.delete(d.Transactions).where((0,u.eq)(d.Transactions.userId,a)),await i.db.delete(d.Rewards).where((0,u.eq)(d.Rewards.userId,a)),await i.db.delete(d.CollectedWastes).where((0,u.eq)(d.CollectedWastes.collectorId,a)),await i.db.update(d.Reports).set({collectorId:null}).where((0,u.eq)(d.Reports.collectorId,a)),await i.db.delete(d.Reports).where((0,u.eq)(d.Reports.userId,a));let e=await i.db.delete(d.Users).where((0,u.eq)(d.Users.id,a)).returning();if(!e[0])return l.NextResponse.json({error:"Failed to delete user"},{status:500});return l.NextResponse.json({message:"User and all related data deleted successfully",deletedUser:{id:e[0].id,name:e[0].name,email:e[0].email}})}catch(e){return l.NextResponse.json({error:"Failed to delete user and related data",details:e instanceof Error?e.message:"Unknown error"},{status:500})}}catch(e){return l.NextResponse.json({error:"Failed to delete user",details:e instanceof Error?e.message:"Unknown error"},{status:500})}}async function N(e){try{if(!e.cookies.get("admin_session")?.value)return l.NextResponse.json({error:"Admin authentication required"},{status:401});let{id:t,name:r,email:a,password:s,balance:n}=await e.json();if(!t)return l.NextResponse.json({error:"User ID is required"},{status:400});if(!r||!a)return l.NextResponse.json({error:"Name and email are required"},{status:400});if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(a))return l.NextResponse.json({error:"Invalid email format"},{status:400});if(void 0!==n&&(isNaN(n)||n<0))return l.NextResponse.json({error:"Balance must be a non-negative number"},{status:400});let o=await i.db.select().from(d.Users).where((0,u.eq)(d.Users.id,t)).limit(1);if(0===o.length)return l.NextResponse.json({error:"User not found"},{status:404});let p=await i.db.select().from(d.Users).where((0,u.eq)(d.Users.email,a)).limit(1);if(p.length>0&&p[0].id!==t)return l.NextResponse.json({error:"Email already exists"},{status:400});let f={name:r,email:a,balance:void 0!==n?n:o[0].balance,updatedAt:new Date};s&&""!==s.trim()&&(f.password_hash=await c.ZP.hash(s,10));let m=await i.db.update(d.Users).set(f).where((0,u.eq)(d.Users.id,t)).returning();if(0===m.length)return l.NextResponse.json({error:"Failed to update user"},{status:500});let{password:N,...w}=m[0],h={...w,createdAt:w.createdAt?.toISOString(),updatedAt:w.updatedAt?.toISOString()};return l.NextResponse.json({message:"User updated successfully",user:h})}catch(e){return l.NextResponse.json({error:"Failed to update user",details:e instanceof Error?e.message:"Unknown error"},{status:500})}}async function w(e){try{if(!e.cookies.get("admin_session")?.value)return l.NextResponse.json({error:"Admin authentication required"},{status:401});let{name:t,email:r,password:a,balance:s=0}=await e.json();if(!t||!r||!a)return l.NextResponse.json({error:"Name, email, and password are required"},{status:400});if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(r))return l.NextResponse.json({error:"Invalid email format"},{status:400});if((await i.db.select().from(d.Users).where((0,u.eq)(d.Users.email,r)).limit(1)).length>0)return l.NextResponse.json({error:"Email already exists"},{status:400});let n=await c.ZP.hash(a,10),o=await i.db.insert(d.Users).values({name:t,email:r,password:n,balance:s||0,createdAt:new Date,updatedAt:new Date}).returning();if(0===o.length)return l.NextResponse.json({error:"Failed to create user"},{status:500});let{password:p,...f}=o[0],m={...f,createdAt:f.createdAt?.toISOString(),updatedAt:f.updatedAt?.toISOString()};return l.NextResponse.json(m,{status:201})}catch(e){return l.NextResponse.json({error:"Failed to create user",details:e instanceof Error?e.message:"Unknown error"},{status:500})}}let h=new s.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/admin/users/route",pathname:"/api/admin/users",filename:"route",bundlePath:"app/api/admin/users/route"},resolvedPagePath:"C:\\Users\\devan\\Downloads\\zero2hero-Waste-Management-System-master\\src\\app\\api\\admin\\users\\route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:_,staticGenerationAsyncStorage:g,serverHooks:A}=h,y="/api/admin/users/route";function L(){return(0,o.patchFetch)({serverHooks:A,staticGenerationAsyncStorage:g})}},42633:(e,t,r)=>{r.d(t,{db:()=>l});var a=r(17917),s=r(62237),n=r(48645);let o=(0,s.qn)("postgresql://neondb_owner:Devansh%4077@ep-weathered-waterfall-a16ci7i1-pooler.ap-southeast-1.aws.neon.tech/neondb?sslmode=require"),l=(0,a.tS)(o,{schema:n})},48645:(e,t,r)=>{r.r(t),r.d(t,{CollectedWastes:()=>m,Notifications:()=>N,Reports:()=>p,Rewards:()=>f,Transactions:()=>w,Users:()=>c,WasteCollectionTasks:()=>_,available_rewards:()=>h,collectedWaste:()=>L,notifications:()=>R,reports:()=>A,rewards:()=>y,transactions:()=>b,users:()=>g,wasteCollectionTasks:()=>v});var a=r(23733),s=r(95961),n=r(41401),o=r(12941),l=r(1575),i=r(72140),d=r(98748),u=r(28680);let c=(0,a.af)("users",{id:(0,s.eP)("id").primaryKey(),name:(0,n.L7)("name",{length:255}).notNull(),email:(0,n.L7)("email",{length:255}).notNull().unique(),password:(0,n.L7)("password",{length:255}),firebaseUid:(0,n.L7)("firebase_uid",{length:255}).unique(),authProvider:(0,n.L7)("auth_provider",{length:20}).default("email").notNull(),balance:(0,o._L)("balance").default(0).notNull(),createdAt:(0,l.AB)("created_at").defaultNow().notNull(),updatedAt:(0,l.AB)("updated_at").defaultNow(),image:(0,i.fL)("image"),publicProfileVisible:(0,d.O7)("public_profile_visible").default(!0).notNull(),profileSearchable:(0,d.O7)("profile_searchable").default(!0).notNull(),showRealName:(0,d.O7)("show_real_name").default(!1).notNull(),personalStatsVisible:(0,d.O7)("personal_stats_visible").default(!0).notNull(),dataSharing:(0,n.L7)("data_sharing",{length:20}).default("anonymous").notNull(),environmentalTracking:(0,d.O7)("environmental_tracking").default(!0).notNull(),collectionHistoryRetention:(0,n.L7)("collection_history_retention",{length:20}).default("1year").notNull()}),p=(0,a.af)("reports",{id:(0,s.eP)("id").primaryKey(),userId:(0,o._L)("user_id").references(()=>c.id),location:(0,i.fL)("location").notNull(),wasteType:(0,n.L7)("waste_type",{length:255}).notNull(),amount:(0,n.L7)("amount",{length:255}).notNull(),imageUrl:(0,i.fL)("image_url"),verificationResult:(0,u.JB)("verification_result"),status:(0,n.L7)("status",{length:255}).notNull().default("pending"),createdAt:(0,l.AB)("created_at").defaultNow().notNull(),collectorId:(0,o._L)("collector_id").references(()=>c.id)}),f=(0,a.af)("rewards",{id:(0,s.eP)("id").primaryKey(),userId:(0,o._L)("user_id").references(()=>c.id).notNull(),points:(0,o._L)("points").notNull().default(0),level:(0,o._L)("level").notNull().default(1),createdAt:(0,l.AB)("created_at").defaultNow().notNull(),updatedAt:(0,l.AB)("updated_at").defaultNow().notNull(),isAvailable:(0,d.O7)("is_available").notNull().default(!0),description:(0,i.fL)("description"),name:(0,n.L7)("name",{length:255}).notNull(),collectionInfo:(0,i.fL)("collection_info").notNull()}),m=(0,a.af)("collected_wastes",{id:(0,s.eP)("id").primaryKey(),reportId:(0,o._L)("report_id").references(()=>p.id).notNull(),collectorId:(0,o._L)("collector_id").references(()=>c.id).notNull(),collectionDate:(0,l.AB)("collection_date").notNull(),status:(0,n.L7)("status",{length:20}).notNull().default("collected"),amount:(0,n.L7)("amount",{length:255}),verificationResult:(0,u.JB)("verification_result")}),N=(0,a.af)("notifications",{id:(0,s.eP)("id").primaryKey(),userId:(0,o._L)("user_id").references(()=>c.id).notNull(),message:(0,i.fL)("message").notNull(),type:(0,n.L7)("type",{length:50}).notNull(),isRead:(0,d.O7)("is_read").notNull().default(!1),imageUrl:(0,i.fL)("image_url"),metadata:(0,u.JB)("metadata"),createdAt:(0,l.AB)("created_at").defaultNow().notNull()}),w=(0,a.af)("transactions",{id:(0,s.eP)("id").primaryKey(),userId:(0,o._L)("user_id").references(()=>c.id).notNull(),type:(0,n.L7)("type",{length:20}).notNull(),amount:(0,o._L)("amount").notNull(),description:(0,i.fL)("description").notNull(),date:(0,l.AB)("date").defaultNow().notNull()}),h=(0,a.af)("available_rewards",{id:(0,s.eP)("id").primaryKey(),name:(0,n.L7)("name",{length:255}).notNull(),description:(0,i.fL)("description"),points_required:(0,o._L)("points_required").notNull(),level_required:(0,o._L)("level_required").notNull(),created_at:(0,l.AB)("created_at").defaultNow().notNull(),updated_at:(0,l.AB)("updated_at").defaultNow().notNull()}),_=(0,a.af)("waste_collection_tasks",{id:(0,s.eP)("id").primaryKey(),createdBy:(0,o._L)("created_by").references(()=>c.id).notNull(),location:(0,i.fL)("location").notNull(),description:(0,i.fL)("description"),status:(0,n.L7)("status",{length:20}).default("active").notNull(),createdAt:(0,l.AB)("created_at").defaultNow().notNull(),completedAt:(0,l.AB)("completed_at")}),g=c,A=p,y=f,L=m,R=N,b=w,v=_}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[8948,5972,7917,8691],()=>r(97457));module.exports=a})();