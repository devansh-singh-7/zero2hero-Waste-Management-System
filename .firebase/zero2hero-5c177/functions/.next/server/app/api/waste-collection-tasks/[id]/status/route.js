"use strict";(()=>{var e={};e.id=9684,e.ids=[9684],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},52826:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>f,patchFetch:()=>m,requestAsyncStorage:()=>u,routeModule:()=>c,serverHooks:()=>w,staticGenerationAsyncStorage:()=>p});var r={};a.r(r),a.d(r,{PUT:()=>d});var o=a(49303),s=a(88716),i=a(60670),n=a(87070),l=a(57044);async function d(e,{params:t}){try{let a=parseInt(t.id),{status:r,collectorId:o}=await e.json(),s=await (0,l.QW)(a,r,o);if(!s)return n.NextResponse.json({error:"Failed to update task status"},{status:400});let i={...s,createdAt:s.createdAt?.toISOString()};return n.NextResponse.json(i)}catch(e){return n.NextResponse.json({error:"Internal server error"},{status:500})}}let c=new o.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/waste-collection-tasks/[id]/status/route",pathname:"/api/waste-collection-tasks/[id]/status",filename:"route",bundlePath:"app/api/waste-collection-tasks/[id]/status/route"},resolvedPagePath:"C:\\Users\\devan\\Downloads\\zero2hero-Waste-Management-System-master\\src\\app\\api\\waste-collection-tasks\\[id]\\status\\route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:u,staticGenerationAsyncStorage:p,serverHooks:w}=c,f="/api/waste-collection-tasks/[id]/status/route";function m(){return(0,i.patchFetch)({serverHooks:w,staticGenerationAsyncStorage:p})}},57044:(e,t,a)=>{a.d(t,{$4:()=>b,CX:()=>d,Go:()=>m,IQ:()=>g,QW:()=>N,VC:()=>v,_Y:()=>R,_y:()=>I,fJ:()=>y,gG:()=>f,n3:()=>L,rF:()=>_,zA:()=>l,zH:()=>h});var r=a(42633),o=a(48645),s=a(57745),i=a(62315),n=a(81445);let l=async()=>{if(!r.db)throw Error("Database not initialized");try{await r.db.select().from(o.Users).limit(1)}catch(e){throw Error("Database connection failed")}return r.db},d=async e=>{if(!e)return null;try{let t=await l();return(await t.select({id:o.Users.id,email:o.Users.email,name:o.Users.name,createdAt:o.Users.createdAt,image:o.Users.image,updatedAt:o.Users.updatedAt}).from(o.Users).where((0,s.eq)(o.Users.email,e)).execute())[0]||null}catch(e){return null}},c=async e=>{try{let t=await l(),[a]=await t.select().from(o.Rewards).where((0,s.eq)(o.Rewards.userId,e));return a||([a]=await t.insert(o.Rewards).values({userId:e,name:"Default Reward",collectionInfo:"Default Collection Info",points:0,level:1,isAvailable:!0}).returning()),a}catch(e){return null}},u=async(e,t)=>{try{let a=await l(),[r]=await a.update(o.Rewards).set({points:(0,i.i6)`${o.Rewards.points} + ${t}`,updatedAt:new Date}).where((0,s.eq)(o.Rewards.userId,e)).returning();return r}catch(e){return null}},p=async(e,t,a,r)=>{try{let s=await l(),[i]=await s.insert(o.Transactions).values({userId:e,type:t,amount:a,description:r,date:new Date}).returning();return i}catch(e){return null}},w=async(e,t,a,r,s)=>{try{let i=await l(),[n]=await i.insert(o.Notifications).values({userId:e,message:t,type:a,imageUrl:r,metadata:s}).returning();return n}catch(e){throw e}},f=async e=>{try{let t=await l();return await t.select().from(o.Notifications).where((0,s.xD)((0,s.eq)(o.Notifications.userId,e),(0,s.eq)(o.Notifications.isRead,!1)))}catch(e){return[]}},m=async e=>{try{let t=await l();return await t.update(o.Notifications).set({isRead:!0}).where((0,s.eq)(o.Notifications.id,e)),!0}catch(e){throw e}},h=async(e=20)=>{try{let t=await l();return await t.select({id:o.Reports.id,userId:o.Reports.userId,location:o.Reports.location,wasteType:o.Reports.wasteType,amount:o.Reports.amount,imageUrl:o.Reports.imageUrl,verificationResult:o.Reports.verificationResult,status:o.Reports.status,createdAt:o.Reports.createdAt,collectorId:o.Reports.collectorId,userName:o.Users.name,userEmail:o.Users.email}).from(o.Reports).leftJoin(o.Users,(0,s.eq)(o.Reports.userId,o.Users.id)).orderBy((0,n.C)(o.Reports.createdAt)).limit(e)}catch(e){return[]}},y=async(e=10)=>{try{let t=await l();return await t.select().from(o.Reports).orderBy((0,n.C)(o.Reports.createdAt)).limit(e)}catch(e){return[]}},_=async(e,t)=>{try{let a=await l(),[r]=await a.insert(o.Rewards).values({userId:e,name:"Waste Collection Reward",collectionInfo:"Points earned from waste collection",points:t,level:1,isAvailable:!0}).returning();return await A(e,"earned_collect",t,"Points earned for collecting waste"),r}catch(e){throw e}},N=async(e,t,a)=>{try{let r=await l();if(void 0!==a){let[e]=await r.select().from(o.Users).where((0,s.eq)(o.Users.id,a)).limit(1);if(!e)throw Error(`Invalid collector ID: ${a}. User does not exist.`)}let i={status:t};void 0!==a&&(i.collectorId=a);let[n]=await r.update(o.Reports).set(i).where((0,s.eq)(o.Reports.id,e)).returning();if(!n)throw Error(`No report found with ID ${e}`);return n}catch(e){throw e}},R=async(e,t,a,r)=>{try{let i=await l(),[n]=await i.select().from(o.Reports).where((0,s.eq)(o.Reports.id,e)).limit(1);if(!n||!n.userId)throw Error("Report not found or missing user ID");let[d]=await i.update(o.Reports).set({status:"completed",collectorId:t,verificationResult:a,imageUrl:r}).where((0,s.eq)(o.Reports.id,e)).returning(),f=(n.wasteType,n.amount,75);await p(n.userId,"earned_collection",f,`Waste collection completed (75 tokens for task completion): ${n.wasteType} at ${n.location}`),await c(n.userId),await u(n.userId,f);let m=`ðŸŽ‰ Your waste report has been collected! You earned ${f} tokens (75 tokens for task completion). ${r?"Check out the completion photo below!":""}`,h={reportId:e,rewardAmount:f,wasteType:n.wasteType,location:n.location,collectionDate:new Date().toISOString()};await w(n.userId,m,"completion_with_photo",r,h);let[y]=await i.insert(o.CollectedWastes).values({reportId:e,collectorId:t,collectionDate:new Date,verificationResult:a}).returning();return{updatedReport:d,collectedWaste:y,rewardAmount:f,userId:n.userId}}catch(e){throw e}},g=async()=>{try{let e=await l();return await e.select({id:o.Rewards.id,userId:o.Rewards.userId,points:o.Rewards.points,level:o.Rewards.level,createdAt:o.Rewards.createdAt,userName:o.Users.name}).from(o.Rewards).leftJoin(o.Users,(0,s.eq)(o.Rewards.userId,o.Users.id)).orderBy((0,n.C)(o.Rewards.points))}catch(e){return[]}},v=async e=>{try{let t=await l();return(await t.select({id:o.Transactions.id,type:o.Transactions.type,amount:o.Transactions.amount,description:o.Transactions.description,date:o.Transactions.date}).from(o.Transactions).where((0,s.eq)(o.Transactions.userId,e)).orderBy((0,n.C)(o.Transactions.date)).limit(10)).map(e=>({...e,date:e.date.toISOString().split("T")[0]}))}catch(e){return[]}},I=async e=>{try{let t=await l(),a=(await v(e)).reduce((e,t)=>t.type.startsWith("earned")?e+t.amount:e-t.amount,0),r=await t.select({id:o.Rewards.id,name:o.Rewards.name,cost:o.Rewards.points,description:o.Rewards.description,collectionInfo:o.Rewards.collectionInfo}).from(o.Rewards).where((0,s.eq)(o.Rewards.isAvailable,!0));return[{id:0,name:"Your Points",cost:a,description:"Redeem your earned points",collectionInfo:"Points earned from reporting and collecting waste"},...r]}catch(e){return[]}},A=async(e,t,a,r)=>{try{let s=await l(),[i]=await s.insert(o.Transactions).values({userId:e,type:t,amount:a,description:r}).returning();return i}catch(e){throw e}},L=async e=>{try{let t=(await r.db.select({type:o.Transactions.type,amount:o.Transactions.amount}).from(o.Transactions).where((0,s.eq)(o.Transactions.userId,e))).reduce((e,t)=>{let a=e;return["earned_report","earned_collection","earned_collect","reward"].includes(t.type)?a=e+t.amount:["redeemed","spent"].includes(t.type)&&(a=e-t.amount),a},0);return Math.max(t,0)}catch(e){return 0}},b=async(e,t,a)=>{try{let r=await l(),[i]=await r.insert(o.CollectedWastes).values({reportId:e,collectorId:t,collectionDate:new Date,status:"collected",verificationResult:a?JSON.stringify(a):null}).returning();if(!i)throw Error("Failed to create collected waste record");await r.update(o.Reports).set({status:"collected",collectorId:t}).where((0,s.eq)(o.Reports.id,e));let[n]=await r.select({userId:o.Reports.userId,location:o.Reports.location}).from(o.Reports).where((0,s.eq)(o.Reports.id,e));return n&&n.userId&&(await r.insert(o.Notifications).values({userId:n.userId,message:`Your reported waste at ${n.location} has been collected and verified!`,type:"collection_complete",isRead:!1}),await u(t,20),await A(t,"earned_collect",20,"Points earned for collecting waste"),await w(t,"You've earned 20 points for collecting waste!","reward")),i}catch(e){throw e}}},42633:(e,t,a)=>{a.d(t,{db:()=>n});var r=a(17917),o=a(62237),s=a(48645);let i=(0,o.qn)("postgresql://neondb_owner:Devansh%4077@ep-weathered-waterfall-a16ci7i1-pooler.ap-southeast-1.aws.neon.tech/neondb?sslmode=require"),n=(0,r.tS)(i,{schema:s})},48645:(e,t,a)=>{a.r(t),a.d(t,{CollectedWastes:()=>f,Notifications:()=>m,Reports:()=>p,Rewards:()=>w,Transactions:()=>h,Users:()=>u,WasteCollectionTasks:()=>_,available_rewards:()=>y,collectedWaste:()=>v,notifications:()=>I,reports:()=>R,rewards:()=>g,transactions:()=>A,users:()=>N,wasteCollectionTasks:()=>L});var r=a(23733),o=a(95961),s=a(41401),i=a(12941),n=a(1575),l=a(72140),d=a(98748),c=a(28680);let u=(0,r.af)("users",{id:(0,o.eP)("id").primaryKey(),name:(0,s.L7)("name",{length:255}).notNull(),email:(0,s.L7)("email",{length:255}).notNull().unique(),password:(0,s.L7)("password",{length:255}),firebaseUid:(0,s.L7)("firebase_uid",{length:255}).unique(),authProvider:(0,s.L7)("auth_provider",{length:20}).default("email").notNull(),balance:(0,i._L)("balance").default(0).notNull(),createdAt:(0,n.AB)("created_at").defaultNow().notNull(),updatedAt:(0,n.AB)("updated_at").defaultNow(),image:(0,l.fL)("image"),publicProfileVisible:(0,d.O7)("public_profile_visible").default(!0).notNull(),profileSearchable:(0,d.O7)("profile_searchable").default(!0).notNull(),showRealName:(0,d.O7)("show_real_name").default(!1).notNull(),personalStatsVisible:(0,d.O7)("personal_stats_visible").default(!0).notNull(),dataSharing:(0,s.L7)("data_sharing",{length:20}).default("anonymous").notNull(),environmentalTracking:(0,d.O7)("environmental_tracking").default(!0).notNull(),collectionHistoryRetention:(0,s.L7)("collection_history_retention",{length:20}).default("1year").notNull()}),p=(0,r.af)("reports",{id:(0,o.eP)("id").primaryKey(),userId:(0,i._L)("user_id").references(()=>u.id),location:(0,l.fL)("location").notNull(),wasteType:(0,s.L7)("waste_type",{length:255}).notNull(),amount:(0,s.L7)("amount",{length:255}).notNull(),imageUrl:(0,l.fL)("image_url"),verificationResult:(0,c.JB)("verification_result"),status:(0,s.L7)("status",{length:255}).notNull().default("pending"),createdAt:(0,n.AB)("created_at").defaultNow().notNull(),collectorId:(0,i._L)("collector_id").references(()=>u.id)}),w=(0,r.af)("rewards",{id:(0,o.eP)("id").primaryKey(),userId:(0,i._L)("user_id").references(()=>u.id).notNull(),points:(0,i._L)("points").notNull().default(0),level:(0,i._L)("level").notNull().default(1),createdAt:(0,n.AB)("created_at").defaultNow().notNull(),updatedAt:(0,n.AB)("updated_at").defaultNow().notNull(),isAvailable:(0,d.O7)("is_available").notNull().default(!0),description:(0,l.fL)("description"),name:(0,s.L7)("name",{length:255}).notNull(),collectionInfo:(0,l.fL)("collection_info").notNull()}),f=(0,r.af)("collected_wastes",{id:(0,o.eP)("id").primaryKey(),reportId:(0,i._L)("report_id").references(()=>p.id).notNull(),collectorId:(0,i._L)("collector_id").references(()=>u.id).notNull(),collectionDate:(0,n.AB)("collection_date").notNull(),status:(0,s.L7)("status",{length:20}).notNull().default("collected"),amount:(0,s.L7)("amount",{length:255}),verificationResult:(0,c.JB)("verification_result")}),m=(0,r.af)("notifications",{id:(0,o.eP)("id").primaryKey(),userId:(0,i._L)("user_id").references(()=>u.id).notNull(),message:(0,l.fL)("message").notNull(),type:(0,s.L7)("type",{length:50}).notNull(),isRead:(0,d.O7)("is_read").notNull().default(!1),imageUrl:(0,l.fL)("image_url"),metadata:(0,c.JB)("metadata"),createdAt:(0,n.AB)("created_at").defaultNow().notNull()}),h=(0,r.af)("transactions",{id:(0,o.eP)("id").primaryKey(),userId:(0,i._L)("user_id").references(()=>u.id).notNull(),type:(0,s.L7)("type",{length:20}).notNull(),amount:(0,i._L)("amount").notNull(),description:(0,l.fL)("description").notNull(),date:(0,n.AB)("date").defaultNow().notNull()}),y=(0,r.af)("available_rewards",{id:(0,o.eP)("id").primaryKey(),name:(0,s.L7)("name",{length:255}).notNull(),description:(0,l.fL)("description"),points_required:(0,i._L)("points_required").notNull(),level_required:(0,i._L)("level_required").notNull(),created_at:(0,n.AB)("created_at").defaultNow().notNull(),updated_at:(0,n.AB)("updated_at").defaultNow().notNull()}),_=(0,r.af)("waste_collection_tasks",{id:(0,o.eP)("id").primaryKey(),createdBy:(0,i._L)("created_by").references(()=>u.id).notNull(),location:(0,l.fL)("location").notNull(),description:(0,l.fL)("description"),status:(0,s.L7)("status",{length:20}).default("active").notNull(),createdAt:(0,n.AB)("created_at").defaultNow().notNull(),completedAt:(0,n.AB)("completed_at")}),N=u,R=p,g=w,v=f,I=m,A=h,L=_}};var t=require("../../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),r=t.X(0,[8948,5972,7917],()=>a(52826));module.exports=r})();