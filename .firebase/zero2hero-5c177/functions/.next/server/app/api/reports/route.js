"use strict";(()=>{var e={};e.id=9867,e.ids=[9867],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},84770:e=>{e.exports=require("crypto")},83905:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>I,patchFetch:()=>v,requestAsyncStorage:()=>f,routeModule:()=>y,serverHooks:()=>g,staticGenerationAsyncStorage:()=>R});var a={};r.r(a),r.d(a,{GET:()=>m,POST:()=>h,dynamic:()=>p,revalidate:()=>w});var s=r(49303),o=r(88716),n=r(60670),i=r(87070),c=r(42633),l=r(48645),d=r(57044),u=r(2310);let p="force-dynamic",w=0;async function m(e){try{let t;let r=await (0,u.I8)();if(!r?.user)return i.NextResponse.json({error:"Authentication required"},{status:401});let{searchParams:a}=new URL(e.url),s=a.get("type")||"recent",o=parseInt(a.get("limit")||"10");if("recent"===s){let e=(t=await (0,d.fJ)(o)).map(e=>({...e,createdAt:e.createdAt?.toISOString()})),r=i.NextResponse.json({reports:e,timestamp:new Date().toISOString(),count:e.length});return r.headers.set("Cache-Control","no-store, no-cache, must-revalidate, proxy-revalidate"),r.headers.set("Pragma","no-cache"),r.headers.set("Expires","0"),r}if("tasks"===s||"collection"===s){t=await (0,d.zH)(o);let e=i.NextResponse.json({tasks:t,timestamp:new Date().toISOString(),count:t.length});return e.headers.set("Cache-Control","no-store, no-cache, must-revalidate, proxy-revalidate"),e.headers.set("Pragma","no-cache"),e.headers.set("Expires","0"),e}{if("all"!==s)return i.NextResponse.json({error:"Invalid type parameter"},{status:400});let e=(t=await (0,d.fJ)(100)).map(e=>({...e,createdAt:e.createdAt?.toISOString()})),r=i.NextResponse.json({reports:e,timestamp:new Date().toISOString(),count:e.length});return r.headers.set("Cache-Control","no-store, no-cache, must-revalidate, proxy-revalidate"),r.headers.set("Pragma","no-cache"),r.headers.set("Expires","0"),r}}catch(e){return i.NextResponse.json({error:"Internal server error"},{status:500})}}async function h(e){try{let t;let{location:r,wasteType:a,amount:s,imageUrl:o,verificationResult:n}=await e.json();if("object"==typeof r){let e=r.lat||r.latitude,a=r.lng||r.longitude;"number"==typeof e&&"number"==typeof a&&e>=-90&&e<=90&&a>=-180&&a<=180&&(t=`${Number(e).toFixed(6)},${Number(a).toFixed(6)}`)}else if("string"==typeof r){let[e,a]=r.split(",").map(e=>Number(e.trim()));!isNaN(e)&&!isNaN(a)&&e>=-90&&e<=90&&a>=-180&&a<=180&&(t=`${e.toFixed(6)},${a.toFixed(6)}`)}if(!t||!a||!s)return i.NextResponse.json({error:"Missing required fields",fields:{location:!!t,wasteType:!!a,amount:!!s}},{status:422});let d=await (0,u.I8)(),p=d?.user?.id;if(!p)return i.NextResponse.json({error:"Authentication required"},{status:401});let[w]=await c.db.insert(l.Reports).values({userId:p,location:t,wasteType:a,amount:s,imageUrl:o,verificationResult:n?JSON.stringify(n):null,status:"pending",createdAt:new Date}).returning();if(!w)throw Error("Failed to create report");await c.db.insert(l.Transactions).values({userId:p,type:"earned_report",amount:10,description:"Points earned for reporting waste",date:new Date}),await c.db.insert(l.Notifications).values({userId:p,message:"Thank you for reporting waste! You've earned 10 points.",type:"report_submitted",isRead:!1,createdAt:new Date});let m=i.NextResponse.json({report:{...w,createdAt:w.createdAt.toISOString()},message:"Report submitted successfully!",pointsEarned:10,timestamp:new Date().toISOString()},{status:201});return m.headers.set("Cache-Control","no-store, no-cache, must-revalidate, proxy-revalidate"),m.headers.set("Pragma","no-cache"),m.headers.set("Expires","0"),m}catch(e){return i.NextResponse.json({error:e instanceof Error?e.message:"Failed to create report"},{status:500})}}let y=new s.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/reports/route",pathname:"/api/reports",filename:"route",bundlePath:"app/api/reports/route"},resolvedPagePath:"C:\\Users\\devan\\Downloads\\zero2hero-Waste-Management-System-master\\src\\app\\api\\reports\\route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:f,staticGenerationAsyncStorage:R,serverHooks:g}=y,I="/api/reports/route";function v(){return(0,n.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:R})}},57044:(e,t,r)=>{r.d(t,{$4:()=>T,CX:()=>l,Go:()=>h,IQ:()=>v,QW:()=>g,VC:()=>x,_Y:()=>I,_y:()=>A,fJ:()=>f,gG:()=>m,n3:()=>q,rF:()=>R,zA:()=>c,zH:()=>y});var a=r(42633),s=r(48645),o=r(57745),n=r(62315),i=r(81445);let c=async()=>{if(!a.db)throw Error("Database not initialized");try{await a.db.select().from(s.Users).limit(1)}catch(e){throw Error("Database connection failed")}return a.db},l=async e=>{if(!e)return null;try{let t=await c();return(await t.select({id:s.Users.id,email:s.Users.email,name:s.Users.name,createdAt:s.Users.createdAt,image:s.Users.image,updatedAt:s.Users.updatedAt}).from(s.Users).where((0,o.eq)(s.Users.email,e)).execute())[0]||null}catch(e){return null}},d=async e=>{try{let t=await c(),[r]=await t.select().from(s.Rewards).where((0,o.eq)(s.Rewards.userId,e));return r||([r]=await t.insert(s.Rewards).values({userId:e,name:"Default Reward",collectionInfo:"Default Collection Info",points:0,level:1,isAvailable:!0}).returning()),r}catch(e){return null}},u=async(e,t)=>{try{let r=await c(),[a]=await r.update(s.Rewards).set({points:(0,n.i6)`${s.Rewards.points} + ${t}`,updatedAt:new Date}).where((0,o.eq)(s.Rewards.userId,e)).returning();return a}catch(e){return null}},p=async(e,t,r,a)=>{try{let o=await c(),[n]=await o.insert(s.Transactions).values({userId:e,type:t,amount:r,description:a,date:new Date}).returning();return n}catch(e){return null}},w=async(e,t,r,a,o)=>{try{let n=await c(),[i]=await n.insert(s.Notifications).values({userId:e,message:t,type:r,imageUrl:a,metadata:o}).returning();return i}catch(e){throw e}},m=async e=>{try{let t=await c();return await t.select().from(s.Notifications).where((0,o.xD)((0,o.eq)(s.Notifications.userId,e),(0,o.eq)(s.Notifications.isRead,!1)))}catch(e){return[]}},h=async e=>{try{let t=await c();return await t.update(s.Notifications).set({isRead:!0}).where((0,o.eq)(s.Notifications.id,e)),!0}catch(e){throw e}},y=async(e=20)=>{try{let t=await c();return await t.select({id:s.Reports.id,userId:s.Reports.userId,location:s.Reports.location,wasteType:s.Reports.wasteType,amount:s.Reports.amount,imageUrl:s.Reports.imageUrl,verificationResult:s.Reports.verificationResult,status:s.Reports.status,createdAt:s.Reports.createdAt,collectorId:s.Reports.collectorId,userName:s.Users.name,userEmail:s.Users.email}).from(s.Reports).leftJoin(s.Users,(0,o.eq)(s.Reports.userId,s.Users.id)).orderBy((0,i.C)(s.Reports.createdAt)).limit(e)}catch(e){return[]}},f=async(e=10)=>{try{let t=await c();return await t.select().from(s.Reports).orderBy((0,i.C)(s.Reports.createdAt)).limit(e)}catch(e){return[]}},R=async(e,t)=>{try{let r=await c(),[a]=await r.insert(s.Rewards).values({userId:e,name:"Waste Collection Reward",collectionInfo:"Points earned from waste collection",points:t,level:1,isAvailable:!0}).returning();return await N(e,"earned_collect",t,"Points earned for collecting waste"),a}catch(e){throw e}},g=async(e,t,r)=>{try{let a=await c();if(void 0!==r){let[e]=await a.select().from(s.Users).where((0,o.eq)(s.Users.id,r)).limit(1);if(!e)throw Error(`Invalid collector ID: ${r}. User does not exist.`)}let n={status:t};void 0!==r&&(n.collectorId=r);let[i]=await a.update(s.Reports).set(n).where((0,o.eq)(s.Reports.id,e)).returning();if(!i)throw Error(`No report found with ID ${e}`);return i}catch(e){throw e}},I=async(e,t,r,a)=>{try{let n=await c(),[i]=await n.select().from(s.Reports).where((0,o.eq)(s.Reports.id,e)).limit(1);if(!i||!i.userId)throw Error("Report not found or missing user ID");let[l]=await n.update(s.Reports).set({status:"completed",collectorId:t,verificationResult:r,imageUrl:a}).where((0,o.eq)(s.Reports.id,e)).returning(),m=(i.wasteType,i.amount,75);await p(i.userId,"earned_collection",m,`Waste collection completed (75 tokens for task completion): ${i.wasteType} at ${i.location}`),await d(i.userId),await u(i.userId,m);let h=`ðŸŽ‰ Your waste report has been collected! You earned ${m} tokens (75 tokens for task completion). ${a?"Check out the completion photo below!":""}`,y={reportId:e,rewardAmount:m,wasteType:i.wasteType,location:i.location,collectionDate:new Date().toISOString()};await w(i.userId,h,"completion_with_photo",a,y);let[f]=await n.insert(s.CollectedWastes).values({reportId:e,collectorId:t,collectionDate:new Date,verificationResult:r}).returning();return{updatedReport:l,collectedWaste:f,rewardAmount:m,userId:i.userId}}catch(e){throw e}},v=async()=>{try{let e=await c();return await e.select({id:s.Rewards.id,userId:s.Rewards.userId,points:s.Rewards.points,level:s.Rewards.level,createdAt:s.Rewards.createdAt,userName:s.Users.name}).from(s.Rewards).leftJoin(s.Users,(0,o.eq)(s.Rewards.userId,s.Users.id)).orderBy((0,i.C)(s.Rewards.points))}catch(e){return[]}},x=async e=>{try{let t=await c();return(await t.select({id:s.Transactions.id,type:s.Transactions.type,amount:s.Transactions.amount,description:s.Transactions.description,date:s.Transactions.date}).from(s.Transactions).where((0,o.eq)(s.Transactions.userId,e)).orderBy((0,i.C)(s.Transactions.date)).limit(10)).map(e=>({...e,date:e.date.toISOString().split("T")[0]}))}catch(e){return[]}},A=async e=>{try{let t=await c(),r=(await x(e)).reduce((e,t)=>t.type.startsWith("earned")?e+t.amount:e-t.amount,0),a=await t.select({id:s.Rewards.id,name:s.Rewards.name,cost:s.Rewards.points,description:s.Rewards.description,collectionInfo:s.Rewards.collectionInfo}).from(s.Rewards).where((0,o.eq)(s.Rewards.isAvailable,!0));return[{id:0,name:"Your Points",cost:r,description:"Redeem your earned points",collectionInfo:"Points earned from reporting and collecting waste"},...a]}catch(e){return[]}},N=async(e,t,r,a)=>{try{let o=await c(),[n]=await o.insert(s.Transactions).values({userId:e,type:t,amount:r,description:a}).returning();return n}catch(e){throw e}},q=async e=>{try{let t=(await a.db.select({type:s.Transactions.type,amount:s.Transactions.amount}).from(s.Transactions).where((0,o.eq)(s.Transactions.userId,e))).reduce((e,t)=>{let r=e;return["earned_report","earned_collection","earned_collect","reward"].includes(t.type)?r=e+t.amount:["redeemed","spent"].includes(t.type)&&(r=e-t.amount),r},0);return Math.max(t,0)}catch(e){return 0}},T=async(e,t,r)=>{try{let a=await c(),[n]=await a.insert(s.CollectedWastes).values({reportId:e,collectorId:t,collectionDate:new Date,status:"collected",verificationResult:r?JSON.stringify(r):null}).returning();if(!n)throw Error("Failed to create collected waste record");await a.update(s.Reports).set({status:"collected",collectorId:t}).where((0,o.eq)(s.Reports.id,e));let[i]=await a.select({userId:s.Reports.userId,location:s.Reports.location}).from(s.Reports).where((0,o.eq)(s.Reports.id,e));return i&&i.userId&&(await a.insert(s.Notifications).values({userId:i.userId,message:`Your reported waste at ${i.location} has been collected and verified!`,type:"collection_complete",isRead:!1}),await u(t,20),await N(t,"earned_collect",20,"Points earned for collecting waste"),await w(t,"You've earned 20 points for collecting waste!","reward")),n}catch(e){throw e}}}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[8948,5972,7917,2310],()=>r(83905));module.exports=a})();