"use strict";(()=>{var e={};e.id=6069,e.ids=[6069],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},84770:e=>{e.exports=require("crypto")},44379:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>h,patchFetch:()=>I,requestAsyncStorage:()=>f,routeModule:()=>m,serverHooks:()=>R,staticGenerationAsyncStorage:()=>y});var a={};r.r(a),r.d(a,{GET:()=>w,PATCH:()=>p,dynamic:()=>u});var s=r(49303),o=r(88716),n=r(60670),i=r(87070),c=r(2310),l=r(42633),d=r(57044);let u="force-dynamic";async function w(e){try{let t=await (0,c.nX)(e);if(!t)return i.NextResponse.json({error:"Unauthorized"},{status:401});if(!l.db)return i.NextResponse.json({error:"Database error"},{status:500});try{let e=await (0,d.gG)(t.id);return i.NextResponse.json(e)}catch(e){return i.NextResponse.json({error:"Failed to fetch notifications"},{status:500})}}catch(e){return i.NextResponse.json({error:e instanceof Error?e.message:"Internal server error"},{status:500})}}async function p(e){try{if(!await (0,c.nX)(e))return i.NextResponse.json({error:"Unauthorized"},{status:401});let{notificationId:t}=await e.json();if(!t)return i.NextResponse.json({error:"Notification ID is required"},{status:400});return await (0,d.Go)(t),i.NextResponse.json({message:"Notification marked as read"})}catch(e){return i.NextResponse.json({error:"Internal server error"},{status:500})}}let m=new s.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/user/notifications/route",pathname:"/api/user/notifications",filename:"route",bundlePath:"app/api/user/notifications/route"},resolvedPagePath:"C:\\Users\\devan\\Downloads\\zero2hero-Waste-Management-System-master\\src\\app\\api\\user\\notifications\\route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:f,staticGenerationAsyncStorage:y,serverHooks:R}=m,h="/api/user/notifications/route";function I(){return(0,n.patchFetch)({serverHooks:R,staticGenerationAsyncStorage:y})}},57044:(e,t,r)=>{r.d(t,{$4:()=>N,CX:()=>l,Go:()=>f,IQ:()=>v,QW:()=>I,VC:()=>x,_Y:()=>g,_y:()=>q,fJ:()=>R,gG:()=>m,n3:()=>T,rF:()=>h,zA:()=>c,zH:()=>y});var a=r(42633),s=r(48645),o=r(57745),n=r(62315),i=r(81445);let c=async()=>{if(!a.db)throw Error("Database not initialized");try{await a.db.select().from(s.Users).limit(1)}catch(e){throw Error("Database connection failed")}return a.db},l=async e=>{if(!e)return null;try{let t=await c();return(await t.select({id:s.Users.id,email:s.Users.email,name:s.Users.name,createdAt:s.Users.createdAt,image:s.Users.image,updatedAt:s.Users.updatedAt}).from(s.Users).where((0,o.eq)(s.Users.email,e)).execute())[0]||null}catch(e){return null}},d=async e=>{try{let t=await c(),[r]=await t.select().from(s.Rewards).where((0,o.eq)(s.Rewards.userId,e));return r||([r]=await t.insert(s.Rewards).values({userId:e,name:"Default Reward",collectionInfo:"Default Collection Info",points:0,level:1,isAvailable:!0}).returning()),r}catch(e){return null}},u=async(e,t)=>{try{let r=await c(),[a]=await r.update(s.Rewards).set({points:(0,n.i6)`${s.Rewards.points} + ${t}`,updatedAt:new Date}).where((0,o.eq)(s.Rewards.userId,e)).returning();return a}catch(e){return null}},w=async(e,t,r,a)=>{try{let o=await c(),[n]=await o.insert(s.Transactions).values({userId:e,type:t,amount:r,description:a,date:new Date}).returning();return n}catch(e){return null}},p=async(e,t,r,a,o)=>{try{let n=await c(),[i]=await n.insert(s.Notifications).values({userId:e,message:t,type:r,imageUrl:a,metadata:o}).returning();return i}catch(e){throw e}},m=async e=>{try{let t=await c();return await t.select().from(s.Notifications).where((0,o.xD)((0,o.eq)(s.Notifications.userId,e),(0,o.eq)(s.Notifications.isRead,!1)))}catch(e){return[]}},f=async e=>{try{let t=await c();return await t.update(s.Notifications).set({isRead:!0}).where((0,o.eq)(s.Notifications.id,e)),!0}catch(e){throw e}},y=async(e=20)=>{try{let t=await c();return await t.select({id:s.Reports.id,userId:s.Reports.userId,location:s.Reports.location,wasteType:s.Reports.wasteType,amount:s.Reports.amount,imageUrl:s.Reports.imageUrl,verificationResult:s.Reports.verificationResult,status:s.Reports.status,createdAt:s.Reports.createdAt,collectorId:s.Reports.collectorId,userName:s.Users.name,userEmail:s.Users.email}).from(s.Reports).leftJoin(s.Users,(0,o.eq)(s.Reports.userId,s.Users.id)).orderBy((0,i.C)(s.Reports.createdAt)).limit(e)}catch(e){return[]}},R=async(e=10)=>{try{let t=await c();return await t.select().from(s.Reports).orderBy((0,i.C)(s.Reports.createdAt)).limit(e)}catch(e){return[]}},h=async(e,t)=>{try{let r=await c(),[a]=await r.insert(s.Rewards).values({userId:e,name:"Waste Collection Reward",collectionInfo:"Points earned from waste collection",points:t,level:1,isAvailable:!0}).returning();return await U(e,"earned_collect",t,"Points earned for collecting waste"),a}catch(e){throw e}},I=async(e,t,r)=>{try{let a=await c();if(void 0!==r){let[e]=await a.select().from(s.Users).where((0,o.eq)(s.Users.id,r)).limit(1);if(!e)throw Error(`Invalid collector ID: ${r}. User does not exist.`)}let n={status:t};void 0!==r&&(n.collectorId=r);let[i]=await a.update(s.Reports).set(n).where((0,o.eq)(s.Reports.id,e)).returning();if(!i)throw Error(`No report found with ID ${e}`);return i}catch(e){throw e}},g=async(e,t,r,a)=>{try{let n=await c(),[i]=await n.select().from(s.Reports).where((0,o.eq)(s.Reports.id,e)).limit(1);if(!i||!i.userId)throw Error("Report not found or missing user ID");let[l]=await n.update(s.Reports).set({status:"completed",collectorId:t,verificationResult:r,imageUrl:a}).where((0,o.eq)(s.Reports.id,e)).returning(),m=(i.wasteType,i.amount,75);await w(i.userId,"earned_collection",m,`Waste collection completed (75 tokens for task completion): ${i.wasteType} at ${i.location}`),await d(i.userId),await u(i.userId,m);let f=`ðŸŽ‰ Your waste report has been collected! You earned ${m} tokens (75 tokens for task completion). ${a?"Check out the completion photo below!":""}`,y={reportId:e,rewardAmount:m,wasteType:i.wasteType,location:i.location,collectionDate:new Date().toISOString()};await p(i.userId,f,"completion_with_photo",a,y);let[R]=await n.insert(s.CollectedWastes).values({reportId:e,collectorId:t,collectionDate:new Date,verificationResult:r}).returning();return{updatedReport:l,collectedWaste:R,rewardAmount:m,userId:i.userId}}catch(e){throw e}},v=async()=>{try{let e=await c();return await e.select({id:s.Rewards.id,userId:s.Rewards.userId,points:s.Rewards.points,level:s.Rewards.level,createdAt:s.Rewards.createdAt,userName:s.Users.name}).from(s.Rewards).leftJoin(s.Users,(0,o.eq)(s.Rewards.userId,s.Users.id)).orderBy((0,i.C)(s.Rewards.points))}catch(e){return[]}},x=async e=>{try{let t=await c();return(await t.select({id:s.Transactions.id,type:s.Transactions.type,amount:s.Transactions.amount,description:s.Transactions.description,date:s.Transactions.date}).from(s.Transactions).where((0,o.eq)(s.Transactions.userId,e)).orderBy((0,i.C)(s.Transactions.date)).limit(10)).map(e=>({...e,date:e.date.toISOString().split("T")[0]}))}catch(e){return[]}},q=async e=>{try{let t=await c(),r=(await x(e)).reduce((e,t)=>t.type.startsWith("earned")?e+t.amount:e-t.amount,0),a=await t.select({id:s.Rewards.id,name:s.Rewards.name,cost:s.Rewards.points,description:s.Rewards.description,collectionInfo:s.Rewards.collectionInfo}).from(s.Rewards).where((0,o.eq)(s.Rewards.isAvailable,!0));return[{id:0,name:"Your Points",cost:r,description:"Redeem your earned points",collectionInfo:"Points earned from reporting and collecting waste"},...a]}catch(e){return[]}},U=async(e,t,r,a)=>{try{let o=await c(),[n]=await o.insert(s.Transactions).values({userId:e,type:t,amount:r,description:a}).returning();return n}catch(e){throw e}},T=async e=>{try{let t=(await a.db.select({type:s.Transactions.type,amount:s.Transactions.amount}).from(s.Transactions).where((0,o.eq)(s.Transactions.userId,e))).reduce((e,t)=>{let r=e;return["earned_report","earned_collection","earned_collect","reward"].includes(t.type)?r=e+t.amount:["redeemed","spent"].includes(t.type)&&(r=e-t.amount),r},0);return Math.max(t,0)}catch(e){return 0}},N=async(e,t,r)=>{try{let a=await c(),[n]=await a.insert(s.CollectedWastes).values({reportId:e,collectorId:t,collectionDate:new Date,status:"collected",verificationResult:r?JSON.stringify(r):null}).returning();if(!n)throw Error("Failed to create collected waste record");await a.update(s.Reports).set({status:"collected",collectorId:t}).where((0,o.eq)(s.Reports.id,e));let[i]=await a.select({userId:s.Reports.userId,location:s.Reports.location}).from(s.Reports).where((0,o.eq)(s.Reports.id,e));return i&&i.userId&&(await a.insert(s.Notifications).values({userId:i.userId,message:`Your reported waste at ${i.location} has been collected and verified!`,type:"collection_complete",isRead:!1}),await u(t,20),await U(t,"earned_collect",20,"Points earned for collecting waste"),await p(t,"You've earned 20 points for collecting waste!","reward")),n}catch(e){throw e}}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[8948,5972,7917,2310],()=>r(44379));module.exports=a})();