"use strict";(()=>{var e={};e.id=4157,e.ids=[4157],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},84770:e=>{e.exports=require("crypto")},83216:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>f,patchFetch:()=>R,requestAsyncStorage:()=>p,routeModule:()=>w,serverHooks:()=>y,staticGenerationAsyncStorage:()=>m});var a={};r.r(a),r.d(a,{PATCH:()=>u,dynamic:()=>d});var s=r(49303),o=r(88716),i=r(60670),n=r(87070),c=r(2310),l=r(57044);let d="force-dynamic";async function u(e,{params:t}){try{if(!await (0,c.nX)(e))return n.NextResponse.json({error:"Unauthorized"},{status:401});let r=parseInt(t.id);if(isNaN(r))return n.NextResponse.json({error:"Invalid notification ID"},{status:400});return await (0,l.Go)(r),n.NextResponse.json({success:!0})}catch(e){return n.NextResponse.json({error:"Internal server error"},{status:500})}}let w=new s.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/user/notifications/[id]/route",pathname:"/api/user/notifications/[id]",filename:"route",bundlePath:"app/api/user/notifications/[id]/route"},resolvedPagePath:"C:\\Users\\devan\\Downloads\\zero2hero-Waste-Management-System-master\\src\\app\\api\\user\\notifications\\[id]\\route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:p,staticGenerationAsyncStorage:m,serverHooks:y}=w,f="/api/user/notifications/[id]/route";function R(){return(0,i.patchFetch)({serverHooks:y,staticGenerationAsyncStorage:m})}},57044:(e,t,r)=>{r.d(t,{$4:()=>A,CX:()=>l,Go:()=>y,IQ:()=>v,QW:()=>I,VC:()=>x,_Y:()=>g,_y:()=>q,fJ:()=>R,gG:()=>m,n3:()=>T,rF:()=>h,zA:()=>c,zH:()=>f});var a=r(42633),s=r(48645),o=r(57745),i=r(62315),n=r(81445);let c=async()=>{if(!a.db)throw Error("Database not initialized");try{await a.db.select().from(s.Users).limit(1)}catch(e){throw Error("Database connection failed")}return a.db},l=async e=>{if(!e)return null;try{let t=await c();return(await t.select({id:s.Users.id,email:s.Users.email,name:s.Users.name,createdAt:s.Users.createdAt,image:s.Users.image,updatedAt:s.Users.updatedAt}).from(s.Users).where((0,o.eq)(s.Users.email,e)).execute())[0]||null}catch(e){return null}},d=async e=>{try{let t=await c(),[r]=await t.select().from(s.Rewards).where((0,o.eq)(s.Rewards.userId,e));return r||([r]=await t.insert(s.Rewards).values({userId:e,name:"Default Reward",collectionInfo:"Default Collection Info",points:0,level:1,isAvailable:!0}).returning()),r}catch(e){return null}},u=async(e,t)=>{try{let r=await c(),[a]=await r.update(s.Rewards).set({points:(0,i.i6)`${s.Rewards.points} + ${t}`,updatedAt:new Date}).where((0,o.eq)(s.Rewards.userId,e)).returning();return a}catch(e){return null}},w=async(e,t,r,a)=>{try{let o=await c(),[i]=await o.insert(s.Transactions).values({userId:e,type:t,amount:r,description:a,date:new Date}).returning();return i}catch(e){return null}},p=async(e,t,r,a,o)=>{try{let i=await c(),[n]=await i.insert(s.Notifications).values({userId:e,message:t,type:r,imageUrl:a,metadata:o}).returning();return n}catch(e){throw e}},m=async e=>{try{let t=await c();return await t.select().from(s.Notifications).where((0,o.xD)((0,o.eq)(s.Notifications.userId,e),(0,o.eq)(s.Notifications.isRead,!1)))}catch(e){return[]}},y=async e=>{try{let t=await c();return await t.update(s.Notifications).set({isRead:!0}).where((0,o.eq)(s.Notifications.id,e)),!0}catch(e){throw e}},f=async(e=20)=>{try{let t=await c();return await t.select({id:s.Reports.id,userId:s.Reports.userId,location:s.Reports.location,wasteType:s.Reports.wasteType,amount:s.Reports.amount,imageUrl:s.Reports.imageUrl,verificationResult:s.Reports.verificationResult,status:s.Reports.status,createdAt:s.Reports.createdAt,collectorId:s.Reports.collectorId,userName:s.Users.name,userEmail:s.Users.email}).from(s.Reports).leftJoin(s.Users,(0,o.eq)(s.Reports.userId,s.Users.id)).orderBy((0,n.C)(s.Reports.createdAt)).limit(e)}catch(e){return[]}},R=async(e=10)=>{try{let t=await c();return await t.select().from(s.Reports).orderBy((0,n.C)(s.Reports.createdAt)).limit(e)}catch(e){return[]}},h=async(e,t)=>{try{let r=await c(),[a]=await r.insert(s.Rewards).values({userId:e,name:"Waste Collection Reward",collectionInfo:"Points earned from waste collection",points:t,level:1,isAvailable:!0}).returning();return await U(e,"earned_collect",t,"Points earned for collecting waste"),a}catch(e){throw e}},I=async(e,t,r)=>{try{let a=await c();if(void 0!==r){let[e]=await a.select().from(s.Users).where((0,o.eq)(s.Users.id,r)).limit(1);if(!e)throw Error(`Invalid collector ID: ${r}. User does not exist.`)}let i={status:t};void 0!==r&&(i.collectorId=r);let[n]=await a.update(s.Reports).set(i).where((0,o.eq)(s.Reports.id,e)).returning();if(!n)throw Error(`No report found with ID ${e}`);return n}catch(e){throw e}},g=async(e,t,r,a)=>{try{let i=await c(),[n]=await i.select().from(s.Reports).where((0,o.eq)(s.Reports.id,e)).limit(1);if(!n||!n.userId)throw Error("Report not found or missing user ID");let[l]=await i.update(s.Reports).set({status:"completed",collectorId:t,verificationResult:r,imageUrl:a}).where((0,o.eq)(s.Reports.id,e)).returning(),m=(n.wasteType,n.amount,75);await w(n.userId,"earned_collection",m,`Waste collection completed (75 tokens for task completion): ${n.wasteType} at ${n.location}`),await d(n.userId),await u(n.userId,m);let y=`ðŸŽ‰ Your waste report has been collected! You earned ${m} tokens (75 tokens for task completion). ${a?"Check out the completion photo below!":""}`,f={reportId:e,rewardAmount:m,wasteType:n.wasteType,location:n.location,collectionDate:new Date().toISOString()};await p(n.userId,y,"completion_with_photo",a,f);let[R]=await i.insert(s.CollectedWastes).values({reportId:e,collectorId:t,collectionDate:new Date,verificationResult:r}).returning();return{updatedReport:l,collectedWaste:R,rewardAmount:m,userId:n.userId}}catch(e){throw e}},v=async()=>{try{let e=await c();return await e.select({id:s.Rewards.id,userId:s.Rewards.userId,points:s.Rewards.points,level:s.Rewards.level,createdAt:s.Rewards.createdAt,userName:s.Users.name}).from(s.Rewards).leftJoin(s.Users,(0,o.eq)(s.Rewards.userId,s.Users.id)).orderBy((0,n.C)(s.Rewards.points))}catch(e){return[]}},x=async e=>{try{let t=await c();return(await t.select({id:s.Transactions.id,type:s.Transactions.type,amount:s.Transactions.amount,description:s.Transactions.description,date:s.Transactions.date}).from(s.Transactions).where((0,o.eq)(s.Transactions.userId,e)).orderBy((0,n.C)(s.Transactions.date)).limit(10)).map(e=>({...e,date:e.date.toISOString().split("T")[0]}))}catch(e){return[]}},q=async e=>{try{let t=await c(),r=(await x(e)).reduce((e,t)=>t.type.startsWith("earned")?e+t.amount:e-t.amount,0),a=await t.select({id:s.Rewards.id,name:s.Rewards.name,cost:s.Rewards.points,description:s.Rewards.description,collectionInfo:s.Rewards.collectionInfo}).from(s.Rewards).where((0,o.eq)(s.Rewards.isAvailable,!0));return[{id:0,name:"Your Points",cost:r,description:"Redeem your earned points",collectionInfo:"Points earned from reporting and collecting waste"},...a]}catch(e){return[]}},U=async(e,t,r,a)=>{try{let o=await c(),[i]=await o.insert(s.Transactions).values({userId:e,type:t,amount:r,description:a}).returning();return i}catch(e){throw e}},T=async e=>{try{let t=(await a.db.select({type:s.Transactions.type,amount:s.Transactions.amount}).from(s.Transactions).where((0,o.eq)(s.Transactions.userId,e))).reduce((e,t)=>{let r=e;return["earned_report","earned_collection","earned_collect","reward"].includes(t.type)?r=e+t.amount:["redeemed","spent"].includes(t.type)&&(r=e-t.amount),r},0);return Math.max(t,0)}catch(e){return 0}},A=async(e,t,r)=>{try{let a=await c(),[i]=await a.insert(s.CollectedWastes).values({reportId:e,collectorId:t,collectionDate:new Date,status:"collected",verificationResult:r?JSON.stringify(r):null}).returning();if(!i)throw Error("Failed to create collected waste record");await a.update(s.Reports).set({status:"collected",collectorId:t}).where((0,o.eq)(s.Reports.id,e));let[n]=await a.select({userId:s.Reports.userId,location:s.Reports.location}).from(s.Reports).where((0,o.eq)(s.Reports.id,e));return n&&n.userId&&(await a.insert(s.Notifications).values({userId:n.userId,message:`Your reported waste at ${n.location} has been collected and verified!`,type:"collection_complete",isRead:!1}),await u(t,20),await U(t,"earned_collect",20,"Points earned for collecting waste"),await p(t,"You've earned 20 points for collecting waste!","reward")),i}catch(e){throw e}}}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[8948,5972,7917,2310],()=>r(83216));module.exports=a})();